"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAll = exports.deleteOne = exports.updateMany = exports.updateOneByQuery = exports.updateOneById = exports.count = exports.getPaging = exports.findByPipeline = exports.findByQuery = exports.findById = exports.create = exports.aggregate = exports.withTransaction = void 0;
const tslib_1 = require("tslib");
const mongoose_1 = tslib_1.__importDefault(require("mongoose"));
const base_response_1 = require("../error/base.response");
///TRANSACTION
async function withTransaction(callback) {
    try {
        let result;
        const session = await mongoose_1.default.startSession();
        await session.withTransaction(async () => {
            result = await callback(session);
        });
        await session.endSession();
        return result;
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.withTransaction = withTransaction;
///AGGREGATE
async function aggregate(model, pipeline) {
    try {
        return await model.aggregate(pipeline);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.aggregate = aggregate;
///CREATE
async function create(model, data, options) {
    try {
        return (await model.create([data], options)).shift(); //shu joyda shift return yoq ed
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.create = create;
///FIND BY ID
async function findById(model, _id, project = {}, options) {
    try {
        const query = { _id, isDeleted: false };
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.findOne(query, projection, options);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findById = findById;
///FIND BY QUERY
async function findByQuery(model, query, project = {}, options) {
    try {
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.findOne(query, projection, options);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findByQuery = findByQuery;
///FIND BY PIPELINE
async function findByPipeline(model, _id, pipeline = [], options) {
    try {
        const baseQuery = {
            isDeleted: false,
            _id,
        };
        const $match = {
            $match: baseQuery
        };
        const $pipeline = [$match, ...pipeline];
        const data = await model.aggregate($pipeline, options);
        return data[0];
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.findByPipeline = findByPipeline;
///FIND BY PAGING
async function getPaging(model, dto, query, sort, pipeline = []) {
    try {
        const baseQuery = {
            isDeleted: false,
            ...query
        };
        const $match = {
            $match: baseQuery
        };
        let $sort = {
            $sort: {
                _id: 1
            }
        };
        if (sort) {
            $sort.$sort = sort;
        }
        const { page, limit } = dto;
        const total = await model.countDocuments(baseQuery);
        const $pipeline = [$match, $sort, ...pipeline];
        const data = await model
            .aggregate($pipeline)
            .skip(limit * (page - 1))
            .limit(limit)
            .project({ __v: 0, isDeleted: 0 });
        return {
            total,
            data
        };
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.getPaging = getPaging;
///COUNT
async function count(model, query) {
    try {
        const baseQuery = {
            isDeleted: false,
            ...query,
        };
        return await model.countDocuments(baseQuery);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.count = count;
///UPDATE ONE BY ID
async function updateOneById(model, _id, data, options) {
    try {
        return await model.updateOne({ _id }, data, options);
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.updateOneById = updateOneById;
///UPDATE ONE BY QUERY
async function updateOneByQuery(model, query, data, options) {
    try {
        await model.findOneAndUpdate(query, data, { ...options, new: true });
        return;
    }
    catch (e) {
        console.log(e);
        throw e;
    }
}
exports.updateOneByQuery = updateOneByQuery;
///UPDATE MANY BY QUERY
async function updateMany(model, query, data, options) {
    try {
        await model.updateMany(query, data, options);
        return;
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.updateMany = updateMany;
///DELETE
async function deleteOne(model, query) {
    try {
        return await model.deleteOne(query);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.deleteOne = deleteOne;
///GET ALL /* custom */
async function getAll(model, project = {}) {
    try {
        const query = { isDeleted: false };
        const projection = { __v: 0, isDeleted: 0, ...project };
        return await model.find(query, projection);
    }
    catch (e) {
        console.log(e);
        throw base_response_1.BaseResponse.UnknownError(e);
    }
}
exports.getAll = getAll;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9zZXJ2aWNlL2Jhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsZ0VBQWlGO0FBRWpGLDBEQUFzRDtBQUd0RCxjQUFjO0FBQ1AsS0FBSyxVQUFVLGVBQWUsQ0FBQyxRQUFRO0lBQzFDLElBQUk7UUFDQSxJQUFJLE1BQU0sQ0FBQztRQUNYLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU5QyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDckMsTUFBTSxHQUFHLE1BQU0sUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BDLENBQUMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDM0IsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFDRCxPQUFPLENBQUMsRUFBRTtRQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZCxNQUFNLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JDO0FBQ0wsQ0FBQztBQWhCRCwwQ0FnQkM7QUFFRCxZQUFZO0FBQ0wsS0FBSyxVQUFVLFNBQVMsQ0FBSSxLQUErQixFQUFFLFFBQWE7SUFDN0UsSUFBSTtRQUNBLE9BQU8sTUFBTSxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0tBQ3pDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2QsTUFBTSw0QkFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUNyQztBQUNMLENBQUM7QUFQRCw4QkFPQztBQUVELFNBQVM7QUFDRixLQUFLLFVBQVUsTUFBTSxDQUFJLEtBQStCLEVBQUUsSUFBSSxF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QU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLDRCQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ3JDO0FBQ0wsQ0FBQztBQVRELGdDQVNDO0FBRUQsU0FBUztBQUNGLEtBQUssVUFBVSxTQUFTLENBQUksS0FBK0IsRUFBRSxLQUFLO0lBQ3JFLElBQUk7UUFDQSxPQUFPLE1BQU0sS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUN0QztJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sNEJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDckM7QUFDTCxDQUFDO0FBUEQsOEJBT0M7QUFFRCx1QkFBdUI7QUFDaEIsS0FBSyxVQUFVLE1BQU0sQ0FBSSxLQUErQixFQUFFLE9BQU8sR0FBRyxFQUFFO0lBQ3pFLElBQUk7UUFDQSxNQUFNLEtBQUssR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQTtRQUNsQyxNQUFNLFVBQVUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxHQUFHLE9BQU8sRUFBRSxDQUFBO1FBQ3ZELE9BQU8sTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQTtLQUM3QztJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLE1BQU0sNEJBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDckM7QUFDTCxDQUFDO0FBVEQsd0JBU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZUFuT2JqZWN0LCBNb2RlbFR5cGUgfSBmcm9tIFwiQHR5cGVnb29zZS90eXBlZ29vc2UvbGliL3R5cGVzXCI7XG5pbXBvcnQgbW9uZ29vc2UsIHsgQWdncmVnYXRlT3B0aW9ucywgUXVlcnlPcHRpb25zLCBTYXZlT3B0aW9ucyB9IGZyb20gXCJtb25nb29zZVwiO1xuaW1wb3J0IHsgUGFnaW5nRHRvIH0gZnJvbSBcIi4uL3ZhbGlkYXRpb24vZHRvL3BhZ2luZy5kdG9cIjtcbmltcG9ydCB7IEJhc2VSZXNwb25zZSB9IGZyb20gXCIuLi9lcnJvci9iYXNlLnJlc3BvbnNlXCI7XG5cblxuLy8vVFJBTlNBQ1RJT05cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoVHJhbnNhY3Rpb24oY2FsbGJhY2spIHtcbiAgICB0cnkge1xuICAgICAgICBsZXQgcmVzdWx0O1xuICAgICAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgbW9uZ29vc2Uuc3RhcnRTZXNzaW9uKCk7XG5cbiAgICAgICAgYXdhaXQgc2Vzc2lvbi53aXRoVHJhbnNhY3Rpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgY2FsbGJhY2soc2Vzc2lvbilcbiAgICAgICAgfSlcblxuICAgICAgICBhd2FpdCBzZXNzaW9uLmVuZFNlc3Npb24oKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vQUdHUkVHQVRFXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWdncmVnYXRlPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHBpcGVsaW5lOiBhbnkpIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuYWdncmVnYXRlKHBpcGVsaW5lKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vQ1JFQVRFXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIGRhdGEsIG9wdGlvbnM/OiBTYXZlT3B0aW9ucykge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiAoYXdhaXQgbW9kZWwuY3JlYXRlKFtkYXRhXSwgb3B0aW9ucykpLnNoaWZ0KCk7Ly9zaHUgam95ZGEgc2hpZnQgcmV0dXJuIHlvcSBlZFxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgdGhyb3cgZVxuICAgIH1cbn1cblxuLy8vRklORCBCWSBJRFxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpbmRCeUlkPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIF9pZDogc3RyaW5nLCBwcm9qZWN0ID0ge30sIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnMpIHtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBxdWVyeSA9IHsgX2lkLCBpc0RlbGV0ZWQ6IGZhbHNlIH07XG4gICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSB7IF9fdjogMCwgaXNEZWxldGVkOiAwLCAuLi5wcm9qZWN0IH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IG1vZGVsLmZpbmRPbmUocXVlcnksIHByb2plY3Rpb24sIG9wdGlvbnMpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9GSU5EIEJZIFFVRVJZXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZEJ5UXVlcnk8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgcXVlcnksIHByb2plY3QgPSB7fSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucykge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSB7IF9fdjogMCwgaXNEZWxldGVkOiAwLCAuLi5wcm9qZWN0IH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IG1vZGVsLmZpbmRPbmUocXVlcnksIHByb2plY3Rpb24sIG9wdGlvbnMpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9GSU5EIEJZIFBJUEVMSU5FXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZEJ5UGlwZWxpbmU8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgX2lkOiBzdHJpbmcsIHBpcGVsaW5lOiBhbnlbXSA9IFtdLCBvcHRpb25zPzogQWdncmVnYXRlT3B0aW9ucykge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGJhc2VRdWVyeSA9IHtcbiAgICAgICAgICAgIGlzRGVsZXRlZDogZmFsc2UsXG4gICAgICAgICAgICBfaWQsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgJG1hdGNoID0ge1xuICAgICAgICAgICAgJG1hdGNoOiBiYXNlUXVlcnlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0ICRwaXBlbGluZSA9IFskbWF0Y2gsIC4uLnBpcGVsaW5lXVxuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgbW9kZWwuYWdncmVnYXRlKCRwaXBlbGluZSwgb3B0aW9ucylcbiAgICAgICAgcmV0dXJuIGRhdGFbMF07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKVxuICAgICAgICB0aHJvdyBCYXNlUmVzcG9uc2UuVW5rbm93bkVycm9yKGUpXG4gICAgfVxufVxuXG4vLy9GSU5EIEJZIFBBR0lOR1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFBhZ2luZzxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBkdG86IFBhZ2luZ0R0bywgcXVlcnk/OiBhbnksIHNvcnQ/OiBhbnksIHBpcGVsaW5lOiBhbnlbXSA9IFtdKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYmFzZVF1ZXJ5ID0ge1xuICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgICAgICAgIC4uLnF1ZXJ5XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgJG1hdGNoID0ge1xuICAgICAgICAgICAgJG1hdGNoOiBiYXNlUXVlcnlcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCAkc29ydCA9IHtcbiAgICAgICAgICAgICRzb3J0OiB7XG4gICAgICAgICAgICAgICAgX2lkOiAxXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNvcnQpIHtcbiAgICAgICAgICAgICRzb3J0LiRzb3J0ID0gc29ydFxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgeyBwYWdlLCBsaW1pdCB9ID0gZHRvO1xuICAgICAgICBjb25zdCB0b3RhbCA9IGF3YWl0IG1vZGVsLmNvdW50RG9jdW1lbnRzKGJhc2VRdWVyeSlcbiAgICAgICAgY29uc3QgJHBpcGVsaW5lID0gWyRtYXRjaCwgJHNvcnQsIC4uLnBpcGVsaW5lXVxuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgbW9kZWxcbiAgICAgICAgICAgIC5hZ2dyZWdhdGUoJHBpcGVsaW5lKVxuICAgICAgICAgICAgLnNraXAobGltaXQgKiAocGFnZSAtIDEpKVxuICAgICAgICAgICAgLmxpbWl0KGxpbWl0KVxuICAgICAgICAgICAgLnByb2plY3QoeyBfX3Y6IDAsIGlzRGVsZXRlZDogMCB9KVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0b3RhbCxcbiAgICAgICAgICAgIGRhdGFcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vQ09VTlRcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb3VudDxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBxdWVyeTogT2JqZWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYmFzZVF1ZXJ5ID0ge1xuICAgICAgICAgICAgaXNEZWxldGVkOiBmYWxzZSxcbiAgICAgICAgICAgIC4uLnF1ZXJ5LFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhd2FpdCBtb2RlbC5jb3VudERvY3VtZW50cyhiYXNlUXVlcnkpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vVVBEQVRFIE9ORSBCWSBJRFxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZU9uZUJ5SWQ8VD4obW9kZWw6IE1vZGVsVHlwZTxULCBCZUFuT2JqZWN0PiwgX2lkOiBzdHJpbmcsIGRhdGEsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnMpIHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwudXBkYXRlT25lKHsgX2lkIH0sIGRhdGEsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIHRocm93IGVcbiAgICB9XG59XG5cbi8vL1VQREFURSBPTkUgQlkgUVVFUllcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVPbmVCeVF1ZXJ5PFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHF1ZXJ5LCBkYXRhLCBvcHRpb25zPzogUXVlcnlPcHRpb25zKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgbW9kZWwuZmluZE9uZUFuZFVwZGF0ZShxdWVyeSwgZGF0YSwgeyAuLi5vcHRpb25zLCBuZXc6IHRydWUgfSk7XG4gICAgICAgIHJldHVyblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIHRocm93IGVcbiAgICB9XG59XG5cbi8vL1VQREFURSBNQU5ZIEJZIFFVRVJZXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlTWFueTxUPihtb2RlbDogTW9kZWxUeXBlPFQsIEJlQW5PYmplY3Q+LCBxdWVyeSwgZGF0YTogb2JqZWN0LCBvcHRpb25zPzogUXVlcnlPcHRpb25zXG4pIHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCBtb2RlbC51cGRhdGVNYW55KHF1ZXJ5LCBkYXRhLCBvcHRpb25zKTtcbiAgICAgICAgcmV0dXJuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdGhyb3cgQmFzZVJlc3BvbnNlLlVua25vd25FcnJvcihlKVxuICAgIH1cbn1cblxuLy8vREVMRVRFXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlT25lPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHF1ZXJ5KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IG1vZGVsLmRlbGV0ZU9uZShxdWVyeSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59XG5cbi8vL0dFVCBBTEwgLyogY3VzdG9tICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QWxsPFQ+KG1vZGVsOiBNb2RlbFR5cGU8VCwgQmVBbk9iamVjdD4sIHByb2plY3QgPSB7fSkge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0geyBpc0RlbGV0ZWQ6IGZhbHNlIH1cbiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHsgX192OiAwLCBpc0RlbGV0ZWQ6IDAsIC4uLnByb2plY3QgfVxuICAgICAgICByZXR1cm4gYXdhaXQgbW9kZWwuZmluZChxdWVyeSwgcHJvamVjdGlvbilcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgIHRocm93IEJhc2VSZXNwb25zZS5Vbmtub3duRXJyb3IoZSlcbiAgICB9XG59Il19